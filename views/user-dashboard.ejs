<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Dashboard</title>
    <link rel="stylesheet" href="/css/user-dashboard.css" />
  </head>

  <body>
    <div class="dashboard-wrapper">
      <header class="dashboard-header">
        <h1 class="dashboard-title">My Dashboard</h1>
        <p class="dashboard-subtitle">
          Welcome back, <%= user?.fullName || user?.email %>
        </p>
      </header>

      <% if (typeof successMessage !== 'undefined' && successMessage) { %>
      <div class="success-message">âœ“ <%= successMessage %></div>
      <% } %>

      <!-- Account Settings Section -->
      <section class="dashboard-section account-section">
        <h2 class="section-title">Account Settings</h2>

        <div class="settings-grid">
          <!-- Update Email -->
          <div class="settings-card">
            <h3>Update Email</h3>
            <form
              action="/user-dashboard/update-email"
              method="POST"
              class="settings-form"
              id="update-email-form"
            >
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />

              <div class="form-group">
                <label for="currentEmail">Current Email</label>
                <input
                  type="email"
                  id="currentEmail"
                  value="<%= user?.email || '' %>"
                  disabled
                  class="form-input disabled-input"
                />
              </div>

              <div class="form-group">
                <label for="newEmail">New Email</label>
                <input
                  type="email"
                  id="newEmail"
                  name="newEmail"
                  placeholder="Enter new email"
                  required
                  class="form-input"
                />
              </div>

              <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input
                  type="password"
                  id="confirmPassword"
                  name="password"
                  placeholder="Enter your password"
                  required
                  class="form-input"
                />
              </div>

              <button type="submit" class="btn update-btn">Update Email</button>
            </form>
          </div>

          <!-- Change Password -->
          <div class="settings-card">
            <h3>Change Password</h3>
            <form
              action="/user-dashboard/change-password"
              method="POST"
              class="settings-form"
              id="change-password-form"
            >
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />

              <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input
                  type="password"
                  id="currentPassword"
                  name="currentPassword"
                  placeholder="Enter current password"
                  required
                  class="form-input"
                />
              </div>

              <div class="form-group">
                <label for="newPassword">New Password</label>
                <input
                  type="password"
                  id="newPassword"
                  name="newPassword"
                  placeholder="Enter new password"
                  required
                  minlength="8"
                  class="form-input"
                />
                <small class="form-hint">Minimum 8 characters</small>
              </div>

              <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password</label>
                <input
                  type="password"
                  id="confirmNewPassword"
                  name="confirmNewPassword"
                  placeholder="Confirm new password"
                  required
                  minlength="8"
                  class="form-input"
                />
              </div>

              <button type="submit" class="btn update-btn">
                Change Password
              </button>
            </form>
          </div>
        </div>
      </section>

      <section class="dashboard-section">
        <% const CHAKRA_LABELS = { rootChakra: 'Root', sacralChakra: 'Sacral',
        solarPlexusChakra: 'Solar Plexus', heartChakra: 'Heart', throatChakra:
        'Throat', thirdEyeChakra: 'Third Eye', crownChakra: 'Crown' }; const
        ARCH_LABELS = { workerBee: 'Worker Bee', martyr: 'Martyr', innerChild:
        'Inner Child', saboteur: 'Saboteur', lover: 'Lover', caretaker:
        'Caretaker', rebel: 'Rebel', creatorVisionary: 'Creator / Visionary',
        ruler: 'Ruler' }; %>
        <h2 class="section-title">Energy Leak Quiz</h2>

        <% if (assessments.length === 0) { %>
        <div class="empty-state">
          <p>You haven't completed any assessments yet.</p>
          <a href="/intro" class="btn start-btn">Take Your First Assessment</a>
        </div>
        <% } else { %>
        <ul class="assessment-list" id="assessment-list">
          <% assessments.forEach(a => { %>
          <li class="assessment-card">
            <div class="assessment-info">
              <h3>
                <%= (CHAKRA_LABELS[a.focusChakra] ? CHAKRA_LABELS[a.focusChakra]
                + ' Chakra' : '-') %>
              </h3>
              <p class="archetype">
                Archetype:
                <strong><%= ARCH_LABELS[a.archetype] || '-' %></strong>
              </p>
              <p class="timestamp">
                <%= new Date(a.createdAt).toLocaleString() %>
              </p>
            </div>
            <div class="assessment-actions">
              <a
                href="/assessment/results?id=<%= a.submissionId %>"
                class="btn view-btn"
                >View</a
              >
              <form
                action="/user-dashboard/delete/<%= a._id %>"
                method="POST"
                class="delete-form"
                data-confirm="Are you sure you want to delete this assessment?"
              >
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <button type="submit" class="btn delete-btn">Delete</button>
              </form>
            </div>
          </li>
          <% }) %>
        </ul>
        <% } %>
      </section>

      <!-- Appointment Booking Section -->
      <section class="dashboard-section">
        <h2 class="section-title">Book an Appointment</h2>

        <div class="appointment-section">
          <p class="section-description">
            Ready for your next session? Schedule an appointment with your
            coach.
          </p>
          <div class="booking-btn-wrapper">
            <a href="/booking" class="btn book-btn">Book Now</a>
          </div>
        </div>
      </section>

      <!-- Upcoming Appointments Section -->
      <section class="dashboard-section">
        <h2 class="section-title">Upcoming Appointments</h2>

        <% if (!upcomingAppointments || upcomingAppointments.length === 0) { %>
        <div class="empty-state">
          <p>You have no upcoming appointments.</p>
          <a href="/booking" class="btn start-btn">Book Your Next Session</a>
        </div>
        <% } else { %>
        <ul class="assessment-list">
          <% upcomingAppointments.forEach(function(a) { %> <% const dateObj =
          new Date(a.appointmentDate); const dateStr =
          dateObj.toLocaleDateString('en-US', { weekday: 'short', month:
          'short', day: 'numeric', year: 'numeric' }); %>
          <li class="assessment-card">
            <div class="assessment-info">
              <h3><%= a.title || "Coaching Session" %></h3>
              <p class="archetype">
                <strong><%= dateStr %></strong>
                at
                <strong><%= a.appointmentTime %></strong>
              </p>

              <% if (a.location) { %>
              <p class="timestamp">Location: <%= a.location %></p>
              <% } %> <% if (a.status) { %>
              <p class="timestamp">Status: <strong><%= a.status %></strong></p>
              <% } %>
            </div>

            <div class="assessment-actions">
              <% if (a.zoomJoinUrl) { %>
              <a
                href="<%= a.zoomJoinUrl %>"
                class="btn view-btn"
                target="_blank"
                rel="noopener noreferrer"
              >
                Join Zoom
              </a>
              <% } %>

              <button
                type="button"
                class="btn view-btn appointment-details-btn"
                data-name="<%= a.clientName || user?.fullName || '' %>"
                data-email="<%= a.clientEmail || user?.email || '' %>"
                data-date="<%= dateStr %>"
                data-time="<%= a.appointmentTime %>"
                data-location="<%= a.location || '' %>"
                data-status="<%= a.status || '' %>"
                data-notes="<%= a.notes || '' %>"
              >
                Details
              </button>
            </div>
          </li>
          <% }); %>
        </ul>
        <% } %>
      </section>

      <!-- Delete Account Section -->
      <section class="dashboard-section danger-section">
        <h2 class="section-title">Danger Zone</h2>

        <div class="danger-card">
          <div class="danger-info">
            <h3>Delete Account</h3>
            <p>
              Once you delete your account, there is no going back. All your
              assessments and data will be permanently removed.
            </p>
          </div>

          <button type="button" class="btn danger-btn" id="open-delete-modal">
            Delete Account
          </button>
        </div>
      </section>
    </div>

    <!-- Appointment Details Modal -->
    <div
      id="appointmentDetailsModal"
      class="modal"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="modal-content" role="document">
        <h2>Appointment Details</h2>

        <div class="appointment-details-content">
          <p><strong>Name:</strong> <span id="appointmentName">-</span></p>
          <p><strong>Email:</strong> <span id="appointmentEmail">-</span></p>
          <p><strong>Date:</strong> <span id="appointmentDate">-</span></p>
          <p><strong>Time:</strong> <span id="appointmentTime">-</span></p>
          <p>
            <strong>Location:</strong> <span id="appointmentLocation">-</span>
          </p>
          <p><strong>Status:</strong> <span id="appointmentStatus">-</span></p>
          <p><strong>Notes:</strong> <span id="appointmentNotes">-</span></p>
        </div>

        <div class="modal-actions">
          <button
            type="button"
            class="btn cancel-btn"
            id="close-appointment-modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Account Confirmation Modal -->
    <div
      id="deleteModal"
      class="modal"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
    >
      <div class="modal-content" role="document">
        <h2>Delete Account</h2>
        <p>Are you absolutely sure? This action cannot be undone.</p>
        <p class="warning-text">This will permanently delete:</p>
        <ul class="warning-list">
          <li>Your account information</li>
          <li>All your assessments and results</li>
          <li>Your appointment history</li>
        </ul>

        <form
          action="/user-dashboard/delete-account"
          method="POST"
          class="delete-account-form"
          id="delete-account-form"
        >
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />

          <div class="form-group">
            <label for="deletePassword">Enter your password to confirm</label>
            <input
              type="password"
              id="deletePassword"
              name="password"
              placeholder="Your password"
              required
              class="form-input"
            />
          </div>

          <div class="modal-actions">
            <button
              type="button"
              class="btn cancel-btn"
              id="close-delete-modal"
            >
              Cancel
            </button>
            <button type="submit" class="btn danger-btn">
              Yes, Delete My Account
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- External script (deferred) -->
    <script src="/js/user-dashboard.js" defer></script>
  </body>
</html>
